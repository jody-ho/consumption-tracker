<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>消費獎賞2025</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div id="container">
    <h1>消費獎賞2025 - 家庭紀錄表</h1>
    
    <!-- 新增優惠券按鈕與日期範圍選擇 -->
    <div id="controls">
      <button id="addCouponBtn">新增優惠券</button>
      <select id="dateRangeSelect">
        <option value="2025/04/14-2025/04/20">2025/04/14 - 2025/04/20</option>
        <option value="2025/04/21-2025/04/27">2025/04/21 - 2025/04/27</option>
        <!-- Add more options here -->
      </select>
      <button id="exportExcelBtn" title="匯出至 Excel">📊</button>
    </div>
    
    <!-- 彈出式視窗新增優惠券 -->
    <div id="addCouponForm" class="form-popup">
      <form id="couponForm">
        <label for="member">家庭成員</label>
        <input type="text" id="member" name="member" required>
        
        <label for="payment">支付方式</label>
        <input type="text" id="payment" name="payment" required>
        
        <label for="amount">金額</label>
        <input type="number" id="amount" name="amount" required>
        
        <button type="submit">提交</button>
        <button type="button" class="close" onclick="closeForm()">關閉</button>
      </form>
    </div>
    
    <!-- 資料顯示區域 -->
    <h2>消費記錄</h2>
    <table id="recordTable">
      <thead>
        <tr>
          <th>家庭成員</th>
          <th>支付方式</th>
          <th>金額</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="recordBody"></tbody>
    </table>

    <h2>每人可消費金額總結</h2>
    <table id="summaryTable">
      <thead>
        <tr>
          <th>家庭成員</th>
          <th>支付方式</th>
          <th>可消費金額</th>
        </tr>
      </thead>
      <tbody id="summaryBody"></tbody>
    </table>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js"></script>
  <script>
    // Firebase 配置
    const firebaseConfig = {
      apiKey: "AIzaSyCJY3vzA7xuC-bC6PLGk5wGAe_rjPMP4w4",
      authDomain: "testing-a7aba.firebaseapp.com",
      projectId: "testing-a7aba",
      storageBucket: "testing-a7aba.appspot.com",
      messagingSenderId: "94291975544",
      appId: "1:94291975544:web:1fc1e0aff39d8fd0357c8d"
    };

    // 初始化 Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database(app);

    let couponData = [];

    // 開啟新增優惠券表單
    document.getElementById("addCouponBtn").addEventListener("click", openForm);

    function openForm() {
      document.getElementById("addCouponForm").style.display = "block";
    }

    // 關閉新增優惠券表單
    function closeForm() {
      document.getElementById("addCouponForm").style.display = "none";
    }

    // 提交新增優惠券
    document.getElementById("couponForm").addEventListener("submit", function (event) {
      event.preventDefault();
      const member = document.getElementById("member").value;
      const payment = document.getElementById("payment").value;
      const amount = parseFloat(document.getElementById("amount").value);

      // 保存到 Firebase
      const couponRef = db.ref("coupons").push();
      couponRef.set({
        member,
        payment,
        amount,
        used: false
      });

      // 關閉表單並更新記錄
      closeForm();
    });

    // 更新消費記錄
    function updateRecords() {
      const recordTable = document.getElementById("recordBody");
      recordTable.innerHTML = "";

      couponData.forEach(coupon => {
        const row = document.createElement("tr");

        if (coupon.used) {
          row.classList.add("underlined");
        }

        row.innerHTML = `
          <td>${coupon.member}</td>
          <td>${coupon.payment}</td>
          <td>${coupon.amount}元</td>
          <td>
            <button onclick="toggleUsed('${coupon.member}', '${coupon.payment}')">標記已使用</button>
            <button onclick="removeEntry('${coupon.member}', '${coupon.payment}')">刪除</button>
          </td>
        `;
        recordTable.appendChild(row);
      });
    }

    // 更新每人可消費金額總結
    function updateSummary() {
      const summaryTable = document.getElementById("summaryBody");
      summaryTable.innerHTML = "";

      let summary = {};

      couponData.forEach(coupon => {
        if (!summary[coupon.member]) {
          summary[coupon.member] = {};
        }
        if (!summary[coupon.member][coupon.payment]) {
          summary[coupon.member][coupon.payment] = 0;
        }
        summary[coupon.member][coupon.payment] += parseFloat(coupon.amount);
      });

      Object.keys(summary).forEach(member => {
        Object.keys(summary[member]).forEach(payment => {
          const row = document.createElement("tr");
          const amount = summary[member][payment];
          row.innerHTML = `<td>${member}</td><td>${payment}</td><td>${amount}元</td>`;
          summaryTable.appendChild(row);
        });
      });
    }

    // 標記為已使用
    function toggleUsed(member, payment) {
      const coupon = couponData.find(coupon => coupon.member === member && coupon.payment === payment);
      coupon.used = !coupon.used;
      updateRecords();
      updateSummary();
    }

    // 刪除記錄
    function removeEntry(member, payment) {
      couponData = couponData.filter(coupon => !(coupon.member === member && coupon.payment === payment));
      updateSummary();
      updateRecords();
    }

    // 匯出至 Excel
    function exportToExcel() {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(couponData);
      XLSX.utils.book_append_sheet(wb, ws, "Coupons");
      XLSX.writeFile(wb, "Coupons.xlsx");
    }

    // 初始化 Firebase 讀取資料
    db.ref("coupons").on("child_added", snapshot => {
      const coupon = snapshot.val();
      couponData.push(coupon);
      updateSummary();
      updateRecords();
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
</body>

</html>
