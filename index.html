<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ¶ˆè²»çè³2025 â€“ å®¶åº­ç´€éŒ„è¡¨</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f4f4f8;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .summary, .entry-form, .week-selector {
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #eee;
    }
    .used {
      text-decoration: line-through;
      color: gray;
    }
    .member-color-çˆ¸çˆ¸ { background-color: #add8e6; }  /* æ·ºè— */
    .member-color-åª½åª½ { background-color: #f8c8dc; }  /* æ·ºç²‰ç´… */
    .member-color-å®¶å§ { background-color: #c1e1c1; }  /* æ·ºç¶  */
    .member-color-æ˜Œå“¥ { background-color: #ffd580; }  /* æ·ºæ©™ */
    .member-color-å¦¹å¦¹ { background-color: #d8b7f8; }  /* æ·ºç´« */
    button.icon {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }
    #popup {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translate(-50%, -20%);
      background: white;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      border-radius: 10px;
      z-index: 1000;
    }
    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
    select, input[type="number"] {
      font-size: 16px;
      padding: 5px;
      margin: 5px;
    }
    .btn-primary {
      background-color: #4CAF50;
      color: white;
      padding: 10px 15px;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>æ¶ˆè²»çè³2025 â€“ å®¶åº­ç´€éŒ„è¡¨</h1>

  <div class="week-selector">
    <label for="weekSelect">é¸æ“‡é€±æ¬¡ï¼š</label>
    <select id="weekSelect"></select>
  </div>

  <div class="summary" id="summary"></div>

  <button class="btn-primary" onclick="showPopup()">â• æ–°å¢å„ªæƒ åˆ¸</button>

  <div id="overlay" onclick="closePopup()"></div>
  <div id="popup">
    <h3>æ–°å¢å„ªæƒ åˆ¸</h3>
    <form id="entryForm">
      <label>å®¶åº­æˆå“¡ï¼š
        <select id="member">
          <option>çˆ¸çˆ¸</option>
          <option>åª½åª½</option>
          <option>å®¶å§</option>
          <option>æ˜Œå“¥</option>
          <option>å¦¹å¦¹</option>
        </select>
      </label><br />
      <label>æ”¯ä»˜æ–¹å¼ï¼š
        <select id="payment">
          <option>ä¸­éŠ€</option>
          <option>å·¥å•†</option>
          <option>åœ‹éš›</option>
          <option>å¤§è±</option>
          <option>MPay</option>
          <option>UEPay</option>
        </select>
      </label><br />
      <label>é‡‘é¡ï¼ˆæœ€å¤šä¸‰ç­†ï¼Œä»¥é€—è™Ÿåˆ†éš”ï¼‰ï¼š<br />
        <input type="text" id="amounts" placeholder="ä¾‹å¦‚ï¼š10,20,50" />
      </label><br /><br />
      <button type="button" class="btn-primary" onclick="addEntries()">ç¢ºèªæ–°å¢</button>
    </form>
  </div>

  <table>
    <thead>
      <tr>
        <th>å®¶åº­æˆå“¡</th>
        <th>æ”¯ä»˜æ–¹å¼</th>
        <th>é‡‘é¡</th>
        <th>å·²ä½¿ç”¨</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="entriesTable"></tbody>
  </table>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCJY3vzA7xuC-bC6PLGk5wGAe_rjPMP4w4",
      authDomain: "testing-a7aba.firebaseapp.com",
      projectId: "testing-a7aba",
      storageBucket: "testing-a7aba.appspot.com",
      messagingSenderId: "94291975544",
      appId: "1:94291975544:web:1fc1e0aff39d8fd0357c8d",
      databaseURL: "https://testing-a7aba-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const weekSelect = document.getElementById('weekSelect');
    const table = document.getElementById('entriesTable');
    const summaryDiv = document.getElementById('summary');

    const today = new Date();
    const startDate = new Date("2025-03-24");
    const currentWeek = Math.ceil((today - startDate) / (7 * 24 * 60 * 60 * 1000)) + 1;

    for (let i = 1; i <= 11; i++) {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = `ç¬¬ ${i} é€±`;
      if (i === currentWeek) opt.selected = true;
      weekSelect.appendChild(opt);
    }

    weekSelect.addEventListener('change', renderData);

    function showPopup() {
      document.getElementById('popup').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    }

    function closePopup() {
      document.getElementById('popup').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }

    function addEntries() {
      const member = document.getElementById('member').value;
      const payment = document.getElementById('payment').value;
      const amounts = document.getElementById('amounts').value.split(',').map(x => parseInt(x.trim())).filter(n => !isNaN(n));
      const week = weekSelect.value;
      amounts.forEach(amount => {
        const newRef = db.ref(`week${week}`).push();
        newRef.set({ member, payment, amount, used: false });
      });
      closePopup();
    }

    function markUsed(key) {
      const week = weekSelect.value;
      db.ref(`week${week}/${key}/used`).set(true);
    }

    function removeEntry(key) {
      const week = weekSelect.value;
      db.ref(`week${week}/${key}`).remove();
    }

    function renderData() {
      const week = weekSelect.value;
      db.ref(`week${week}`).on('value', snapshot => {
        const data = snapshot.val() || {};
        table.innerHTML = '';

        const summary = {};
        let familyTotal = 0;

        Object.entries(data).forEach(([key, entry]) => {
          const row = document.createElement('tr');
          row.className = `member-color-${entry.member}`;
          row.innerHTML = `
            <td>${entry.member}</td>
            <td>${entry.payment}</td>
            <td>${entry.amount}</td>
            <td>${entry.used ? 'âœ”ï¸' : ''}</td>
            <td>
              <button class="icon" onclick="markUsed('${key}')">âœ…</button>
              <button class="icon" onclick="removeEntry('${key}')">ğŸ—‘ï¸</button>
            </td>
          `;
          table.appendChild(row);

          const multiplier = entry.used ? 0 : 3;
          if (!summary[entry.member]) summary[entry.member] = { total: 0, methods: {} };
          summary[entry.member].total += entry.amount * multiplier;
          summary[entry.member].methods[entry.payment] = (summary[entry.member].methods[entry.payment] || 0) + entry.amount * multiplier;
          familyTotal += entry.amount * multiplier;
        });

        summaryDiv.innerHTML = `<h3>æ•´é«”å¯æ¶ˆè²»é‡‘é¡ï¼š$${familyTotal}</h3>` +
          Object.entries(summary).map(([member, info]) => {
            return `
              <div>
                <strong>${member}</strong>ï¼šç¸½è¨ˆ $${info.total}<br/>
                ${Object.entries(info.methods).map(([method, amt]) => `${method}ï¼š$${amt}`).join(', ')}
              </div><br/>
            `;
          }).join('');
      });
    }

    renderData();
  </script>
</body>
</html>
