<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¶ˆè²»çè³2025</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div id="container">
    <h1>æ¶ˆè²»çè³2025 - å®¶åº­ç´€éŒ„è¡¨</h1>
    
    <!-- æ–°å¢å„ªæƒ åˆ¸æŒ‰éˆ•èˆ‡æ—¥æœŸç¯„åœé¸æ“‡ -->
    <div id="controls">
      <button id="addCouponBtn">æ–°å¢å„ªæƒ åˆ¸</button>
      <select id="dateRangeSelect">
        <option value="2025/04/14-2025/04/20">2025/04/14 - 2025/04/20</option>
        <option value="2025/04/21-2025/04/27">2025/04/21 - 2025/04/27</option>
        <!-- Add more options here -->
      </select>
      <button id="exportExcelBtn" title="åŒ¯å‡ºè‡³ Excel">ğŸ“Š</button>
    </div>
    
    <!-- å½ˆå‡ºå¼è¦–çª—æ–°å¢å„ªæƒ åˆ¸ -->
    <div id="addCouponForm" class="form-popup">
      <form id="couponForm">
        <label for="member">å®¶åº­æˆå“¡</label>
        <input type="text" id="member" name="member" required>
        
        <label for="payment">æ”¯ä»˜æ–¹å¼</label>
        <input type="text" id="payment" name="payment" required>
        
        <label for="amount">é‡‘é¡</label>
        <input type="number" id="amount" name="amount" required>
        
        <button type="submit">æäº¤</button>
        <button type="button" class="close" onclick="closeForm()">é—œé–‰</button>
      </form>
    </div>
    
    <!-- è³‡æ–™é¡¯ç¤ºå€åŸŸ -->
    <h2>æ¶ˆè²»è¨˜éŒ„</h2>
    <table id="recordTable">
      <thead>
        <tr>
          <th>å®¶åº­æˆå“¡</th>
          <th>æ”¯ä»˜æ–¹å¼</th>
          <th>é‡‘é¡</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="recordBody"></tbody>
    </table>

    <h2>æ¯äººå¯æ¶ˆè²»é‡‘é¡ç¸½çµ</h2>
    <table id="summaryTable">
      <thead>
        <tr>
          <th>å®¶åº­æˆå“¡</th>
          <th>æ”¯ä»˜æ–¹å¼</th>
          <th>å¯æ¶ˆè²»é‡‘é¡</th>
        </tr>
      </thead>
      <tbody id="summaryBody"></tbody>
    </table>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js"></script>
  <script>
    // Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyCJY3vzA7xuC-bC6PLGk5wGAe_rjPMP4w4",
      authDomain: "testing-a7aba.firebaseapp.com",
      projectId: "testing-a7aba",
      storageBucket: "testing-a7aba.appspot.com",
      messagingSenderId: "94291975544",
      appId: "1:94291975544:web:1fc1e0aff39d8fd0357c8d"
    };

    // åˆå§‹åŒ– Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database(app);

    let couponData = [];

    // é–‹å•Ÿæ–°å¢å„ªæƒ åˆ¸è¡¨å–®
    document.getElementById("addCouponBtn").addEventListener("click", openForm);

    function openForm() {
      document.getElementById("addCouponForm").style.display = "block";
    }

    // é—œé–‰æ–°å¢å„ªæƒ åˆ¸è¡¨å–®
    function closeForm() {
      document.getElementById("addCouponForm").style.display = "none";
    }

    // æäº¤æ–°å¢å„ªæƒ åˆ¸
    document.getElementById("couponForm").addEventListener("submit", function (event) {
      event.preventDefault();
      const member = document.getElementById("member").value;
      const payment = document.getElementById("payment").value;
      const amount = parseFloat(document.getElementById("amount").value);

      // ä¿å­˜åˆ° Firebase
      const couponRef = db.ref("coupons").push();
      couponRef.set({
        member,
        payment,
        amount,
        used: false
      });

      // é—œé–‰è¡¨å–®ä¸¦æ›´æ–°è¨˜éŒ„
      closeForm();
    });

    // æ›´æ–°æ¶ˆè²»è¨˜éŒ„
    function updateRecords() {
      const recordTable = document.getElementById("recordBody");
      recordTable.innerHTML = "";

      couponData.forEach(coupon => {
        const row = document.createElement("tr");

        if (coupon.used) {
          row.classList.add("underlined");
        }

        row.innerHTML = `
          <td>${coupon.member}</td>
          <td>${coupon.payment}</td>
          <td>${coupon.amount}å…ƒ</td>
          <td>
            <button onclick="toggleUsed('${coupon.member}', '${coupon.payment}')">æ¨™è¨˜å·²ä½¿ç”¨</button>
            <button onclick="removeEntry('${coupon.member}', '${coupon.payment}')">åˆªé™¤</button>
          </td>
        `;
        recordTable.appendChild(row);
      });
    }

    // æ›´æ–°æ¯äººå¯æ¶ˆè²»é‡‘é¡ç¸½çµ
    function updateSummary() {
      const summaryTable = document.getElementById("summaryBody");
      summaryTable.innerHTML = "";

      let summary = {};

      couponData.forEach(coupon => {
        if (!summary[coupon.member]) {
          summary[coupon.member] = {};
        }
        if (!summary[coupon.member][coupon.payment]) {
          summary[coupon.member][coupon.payment] = 0;
        }
        summary[coupon.member][coupon.payment] += parseFloat(coupon.amount);
      });

      Object.keys(summary).forEach(member => {
        Object.keys(summary[member]).forEach(payment => {
          const row = document.createElement("tr");
          const amount = summary[member][payment];
          row.innerHTML = `<td>${member}</td><td>${payment}</td><td>${amount}å…ƒ</td>`;
          summaryTable.appendChild(row);
        });
      });
    }

    // æ¨™è¨˜ç‚ºå·²ä½¿ç”¨
    function toggleUsed(member, payment) {
      const coupon = couponData.find(coupon => coupon.member === member && coupon.payment === payment);
      coupon.used = !coupon.used;
      updateRecords();
      updateSummary();
    }

    // åˆªé™¤è¨˜éŒ„
    function removeEntry(member, payment) {
      couponData = couponData.filter(coupon => !(coupon.member === member && coupon.payment === payment));
      updateSummary();
      updateRecords();
    }

    // åŒ¯å‡ºè‡³ Excel
    function exportToExcel() {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(couponData);
      XLSX.utils.book_append_sheet(wb, ws, "Coupons");
      XLSX.writeFile(wb, "Coupons.xlsx");
    }

    // åˆå§‹åŒ– Firebase è®€å–è³‡æ–™
    db.ref("coupons").on("child_added", snapshot => {
      const coupon = snapshot.val();
      couponData.push(coupon);
      updateSummary();
      updateRecords();
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
</body>

</html>
